execution:
  - concurrency: 1
    hold-for: 1m
    scenario: full-supply-approved-products
  - concurrency: 1
    hold-for: 1m
    scenario: non-full-supply-approved-products

scenarios:
  get-user-token:
    requests:
      - url: ${__P(base-uri)}/api/oauth/token
        method: POST
        label: GetUserToken
        headers:
          Authorization: Basic ${__base64Encode(${__P(basic-auth)})}
        body:
          grant_type: password
          username: ${__P(username)}
          password: ${__P(password)}
        extract-jsonpath:
          access_token:
            jsonpath: $.access_token
  get-facility-uuid:
    requests:
      - include-scenario: get-user-token
      - url: ${__P(base-uri)}/api/facilities/search
        method: POST
        label: GetBalakaDistrictHospitalFacility
        body:
          code: DH01
        headers:
          Authorization: Bearer ${access_token}
          Content-Type: application/json
        extract-jsonpath:
          facuuid:
            jsonpath: $.content[:1].id
        jsr223:
          script-text: |
            String uuid = vars.get("facuuid");
            uuid = uuid.replaceAll(/"|\[|\]/, "");
            vars.put("facuuid", uuid);
  get-program-uuid:
    requests:
      - include-scenario: get-user-token
      - url: ${__P(base-uri)}/api/programs/search?name=Essential%20Meds
        method: GET
        label: GetEssentialMedsProgram
        headers:
          Authorization: Bearer ${access_token}
        extract-jsonpath:
          prouuid:
            jsonpath: $.content[:1].id
        jsr223:
          script-text: |
            String uuid = vars.get("prouuid");
            uuid = uuid.replaceAll(/"|\[|\]/, "");
            vars.put("prouuid", uuid);
  full-supply-approved-products:
    requests:
      - include-scenario: get-facility-uuid
      - include-scenario: get-program-uuid
      - url: ${__P(base-uri)}/api/facilities/${facuuid}/approvedProducts?fullSupply=true&programId=${prouuid}
        method: GET
        label: GetFacilitiesApprovedFullSupplyProducts
        headers:
          Authorization: Bearer ${access_token}
  non-full-supply-approved-products:
    requests:
      - include-scenario: get-facility-uuid
      - include-scenario: get-program-uuid
      - url: ${__P(base-uri)}/api/facilities/${facuuid}/approvedProducts?fullSupply=false&programId=${prouuid}
        method: GET
        label: GetFacilitiesApprovedNonFullSupplyProducts
        headers:
          Authorization: Bearer ${access_token}

reporting:
    - module: passfail
      criteria:
        90% of get facilities approved full supply products fail to get in 550ms milliseconds: p90 of GetFacilitiesApprovedFullSupplyProducts>550ms, continue as failed
        90% of get facilities approved non-full supply products fail to get in 350ms milliseconds: p90 of GetFacilitiesApprovedNonFullSupplyProducts>350ms, continue as failed
